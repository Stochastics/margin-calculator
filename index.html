<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Margin + Dividend Reinvestment Compounder</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #0f0f1a; color: #e0e0e0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 24px; }
  .container { max-width: 1000px; margin: 0 auto; }
  h1 { font-size: 22px; font-weight: 700; color: #fff; margin-bottom: 4px; }
  .subtitle { color: #888; font-size: 14px; margin-bottom: 24px; }
  .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 28px; background: #1a1a2e; padding: 16px; border-radius: 10px; }
  .control label { font-size: 11px; color: #888; display: block; margin-bottom: 4px; }
  .control .value { font-size: 16px; font-weight: 600; color: #fff; margin-bottom: 4px; }
  input[type="range"] { width: 100%; accent-color: #6366f1; }
  .freq-btns { display: flex; gap: 6px; margin-top: 6px; }
  .freq-btn { flex: 1; padding: 4px 0; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 4px; border: 1px solid #444; background: transparent; color: #888; }
  .freq-btn.active { border-color: #6366f1; background: #6366f1; color: #fff; }
  .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 28px; }
  .metric { background: #1a1a2e; border-radius: 8px; padding: 12px 14px; }
  .metric .label { font-size: 11px; color: #888; }
  .metric .val { font-size: 18px; font-weight: 700; }
  .chart-box { background: #1a1a2e; border-radius: 10px; padding: 16px; margin-bottom: 20px; }
  .chart-box h3 { font-size: 15px; margin-bottom: 12px; color: #fff; }
  .table-wrap { background: #1a1a2e; border-radius: 10px; padding: 16px; overflow-x: auto; margin-bottom: 20px; }
  .table-wrap h3 { font-size: 15px; margin-bottom: 12px; color: #fff; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { padding: 8px 6px; text-align: right; color: #888; font-weight: 600; font-size: 11px; border-bottom: 1px solid #333; }
  td { padding: 8px 6px; text-align: right; border-bottom: 1px solid #222; }
  .disclaimer { margin-top: 20px; padding: 14px; background: #1a1a2e; border-radius: 10px; border-left: 3px solid #f59e0b; font-size: 12px; color: #888; }
  .disclaimer strong { color: #f59e0b; }
  canvas { max-height: 300px; }
</style>
</head>
<body>
<div class="container">
  <h1>Margin + Dividend Reinvestment Compounder</h1>
  <p class="subtitle">Maintaining leverage ratio as equity grows from reinvested dividends</p>

  <div class="controls">
    <div class="control">
      <label>Starting Equity</label>
      <div class="value" id="v-equity"></div>
      <input type="range" id="equity" min="50000" max="2000000" step="10000" value="400000" />
    </div>
    <div class="control">
      <label>Years</label>
      <div class="value" id="v-years"></div>
      <input type="range" id="years" min="1" max="20" step="1" value="5" />
    </div>
    <div class="control">
      <label>Div Yield %</label>
      <div class="value" id="v-divYield"></div>
      <input type="range" id="divYield" min="4" max="18" step="0.25" value="10.5" />
    </div>
    <div class="control">
      <label>Margin Rate %</label>
      <div class="value" id="v-marginRate"></div>
      <input type="range" id="marginRate" min="2" max="10" step="0.25" value="4.5" />
    </div>
    <div class="control">
      <label>Drawdown Survival %</label>
      <div class="value" id="v-drawdown"></div>
      <input type="range" id="drawdown" min="30" max="85" step="5" value="70" />
    </div>
    <div class="control">
      <label>Maintenance Req %</label>
      <div class="value" id="v-maintReq"></div>
      <input type="range" id="maintReq" min="20" max="50" step="5" value="25" />
    </div>
    <div class="control">
      <label>Tax Rate %</label>
      <div class="value" id="v-taxRate"></div>
      <input type="range" id="taxRate" min="0" max="50" step="1" value="0" />
    </div>
    <div class="control">
      <label id="cap-label">Additional Capital (Monthly)</label>
      <div class="value" id="v-addCapital"></div>
      <input type="range" id="addCapital" min="0" max="10000" step="100" value="0" />
      <div class="freq-btns">
        <button class="freq-btn active" id="btn-monthly" onclick="setFreq('monthly')">Monthly</button>
        <button class="freq-btn" id="btn-annual" onclick="setFreq('annual')">Annual</button>
      </div>
    </div>
  </div>

  <div class="metrics" id="metrics"></div>

  <div class="chart-box">
    <h3>Equity Growth Over Time</h3>
    <canvas id="equityChart"></canvas>
  </div>

  <div class="chart-box">
    <h3>Annual Net Income Comparison</h3>
    <canvas id="incomeChart"></canvas>
  </div>

  <div class="table-wrap">
    <h3>Year-by-Year Breakdown</h3>
    <table>
      <thead>
        <tr>
          <th>Year</th><th>No-Margin Equity</th><th>Margin Equity</th><th>Margin Debt</th>
          <th>Total Invested</th><th>NM Income/yr</th><th>Margin Income/yr</th><th>Income Delta</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div class="disclaimer">
    <strong>Assumptions:</strong> Flat portfolio price (no capital gains/losses), dividends reinvested after tax at same yield,
    additional capital contributions added at end of each year, margin rate and yield constant, leverage ratio
    maintained by increasing borrowing as equity grows. Tax rate applies to gross dividends; margin interest is not tax-deductible in this model.
    Real-world results will vary â€” BDC/CEF distributions may fluctuate, margin requirements can change, and actual tax treatment depends on income type (qualified vs ordinary).
  </div>
</div>

<script>
const $ = (id) => document.getElementById(id);
const fmt = (v) => '$' + Math.round(v).toLocaleString();
const fmtPct = (v) => v.toFixed(2) + '%';

let capFreq = 'monthly';
let equityChart, incomeChart;

function setFreq(f) {
  capFreq = f;
  $('btn-monthly').className = 'freq-btn' + (f === 'monthly' ? ' active' : '');
  $('btn-annual').className = 'freq-btn' + (f === 'annual' ? ' active' : '');
  $('cap-label').textContent = 'Additional Capital (' + (f === 'monthly' ? 'Monthly' : 'Annual') + ')';
  const slider = $('addCapital');
  slider.max = f === 'monthly' ? 10000 : 120000;
  slider.step = f === 'monthly' ? 100 : 1000;
  slider.value = 0;
  update();
}

function compute() {
  const equity = +$('equity').value;
  const years = +$('years').value;
  const r = +$('divYield').value / 100;
  const i = +$('marginRate').value / 100;
  const dd = +$('drawdown').value;
  const maint = +$('maintReq').value / 100;
  const addCap = +$('addCapital').value;
  const tax = +$('taxRate').value / 100;
  const annualContrib = capFreq === 'monthly' ? addCap * 12 : addCap;

  const retain = (100 - dd) / 100;
  const levRatio = (retain - maint * retain) / (1 - retain + maint * retain);
  const afterTaxYield = r * (1 - tax);
  const nmGrowth = afterTaxYield;
  const wmGrowth = (1 + levRatio) * afterTaxYield - levRatio * i;

  let nm = equity, wm = equity;
  const data = [];

  for (let yr = 0; yr <= years; yr++) {
    const wmDebt = wm * levRatio;
    const wmTotal = wm + wmDebt;
    const nmGrossIncome = nm * r;
    const nmNetIncome = nmGrossIncome * (1 - tax);
    const wmGrossIncome = wmTotal * r;
    const wmNetIncome = wmGrossIncome * (1 - tax) - wmDebt * i;
    data.push({
      year: yr,
      nmEq: Math.round(nm),
      wmEq: Math.round(wm),
      wmDebt: Math.round(wmDebt),
      wmTotal: Math.round(wmTotal),
      nmIncome: Math.round(nmNetIncome),
      wmIncome: Math.round(wmNetIncome),
      delta: Math.round(wmNetIncome - nmNetIncome),
      eqDelta: Math.round(wm - nm),
    });
    if (yr < years) {
      nm = nm * (1 + afterTaxYield) + annualContrib;
      wm = wm * (1 + wmGrowth) + annualContrib;
    }
  }

  return { data, levRatio, nmGrowth, wmGrowth, annualContrib, equity };
}

function renderMetrics(res) {
  const { data, levRatio, nmGrowth, wmGrowth, annualContrib, equity } = res;
  const fin = data[data.length - 1];
  const yrs = data.length - 1;
  const items = [
    { label: 'Initial Borrow', value: fmt(equity * levRatio), color: '#f59e0b' },
    { label: 'Leverage Ratio', value: (levRatio * 100).toFixed(1) + '% D/E', color: '#f59e0b' },
    { label: 'No-Margin Growth', value: fmtPct(nmGrowth * 100), color: '#60a5fa' },
    { label: 'With-Margin Growth', value: fmtPct(wmGrowth * 100), color: '#34d399' },
    { label: 'Annual Contributions', value: fmt(annualContrib), color: '#818cf8' },
    { label: 'Extra Equity (Yr ' + yrs + ')', value: fmt(fin.eqDelta), color: '#a78bfa' },
    { label: 'Extra Income (Yr ' + yrs + ')', value: fmt(fin.delta) + '/yr', color: '#a78bfa' },
  ];
  $('metrics').innerHTML = items.map(m =>
    `<div class="metric" style="border-left:3px solid ${m.color}">
      <div class="label">${m.label}</div>
      <div class="val" style="color:${m.color}">${m.value}</div>
    </div>`
  ).join('');
}

function renderCharts(res) {
  const { data } = res;
  const labels = data.map(d => d.year);
  const chartOpts = {
    responsive: true,
    plugins: {
      legend: { labels: { color: '#aaa', font: { size: 12 } } },
      tooltip: {
        callbacks: { label: (ctx) => ctx.dataset.label + ': ' + fmt(ctx.parsed.y) }
      }
    },
    scales: {
      x: { ticks: { color: '#888' }, grid: { color: '#222' } },
      y: { ticks: { color: '#888', callback: (v) => '$' + (v / 1000).toFixed(0) + 'K' }, grid: { color: '#222' } }
    }
  };

  if (equityChart) equityChart.destroy();
  equityChart = new Chart($('equityChart'), {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'No Margin', data: data.map(d => d.nmEq), borderColor: '#60a5fa', backgroundColor: '#60a5fa33', borderWidth: 2.5, pointRadius: 4, tension: 0.1, fill: false },
        { label: 'With Margin', data: data.map(d => d.wmEq), borderColor: '#34d399', backgroundColor: '#34d39933', borderWidth: 2.5, pointRadius: 4, tension: 0.1, fill: false },
      ]
    },
    options: chartOpts
  });

  const incomeData = data.filter(d => d.year > 0);
  const incomeLabels = incomeData.map(d => d.year);

  if (incomeChart) incomeChart.destroy();
  incomeChart = new Chart($('incomeChart'), {
    type: 'bar',
    data: {
      labels: incomeLabels,
      datasets: [
        { label: 'No Margin Income', data: incomeData.map(d => d.nmIncome), backgroundColor: '#60a5fa', borderRadius: 4 },
        { label: 'Margin Net Income', data: incomeData.map(d => d.wmIncome), backgroundColor: '#34d399', borderRadius: 4 },
      ]
    },
    options: chartOpts
  });
}

function renderTable(res) {
  const { data } = res;
  $('tableBody').innerHTML = data.map(d =>
    `<tr>
      <td style="color:#fff;font-weight:600">${d.year}</td>
      <td style="color:#60a5fa">${fmt(d.nmEq)}</td>
      <td style="color:#34d399">${fmt(d.wmEq)}</td>
      <td style="color:#f59e0b">${fmt(d.wmDebt)}</td>
      <td style="color:#e0e0e0">${fmt(d.wmTotal)}</td>
      <td style="color:#60a5fa">${fmt(d.nmIncome)}</td>
      <td style="color:#34d399">${fmt(d.wmIncome)}</td>
      <td style="color:#a78bfa;font-weight:600">+${fmt(d.delta)}</td>
    </tr>`
  ).join('');
}

function updateLabels() {
  $('v-equity').textContent = fmt(+$('equity').value);
  $('v-years').textContent = $('years').value;
  $('v-divYield').textContent = $('divYield').value + '%';
  $('v-marginRate').textContent = $('marginRate').value + '%';
  $('v-drawdown').textContent = $('drawdown').value + '%';
  $('v-maintReq').textContent = $('maintReq').value + '%';
  $('v-taxRate').textContent = $('taxRate').value + '%';
  $('v-addCapital').textContent = fmt(+$('addCapital').value);
}

function update() {
  updateLabels();
  const res = compute();
  renderMetrics(res);
  renderCharts(res);
  renderTable(res);
}

// Attach listeners to all sliders
document.querySelectorAll('input[type="range"]').forEach(el => {
  el.addEventListener('input', update);
});

// Initial render
update();
</script>
</body>
</html>
